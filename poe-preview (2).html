<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3DåŠ¨ä½œèµ„æºåº“ - å¢å¼ºç‰ˆFBXé¢„è§ˆ</title>
    <style>
        :root {
            --primary-color: #D4AF37; /* é‡‘è‰²ä¸»é¢˜è‰² */
            --primary-color-dark: #AA8C2C; /* æ·±é‡‘è‰² */
            --primary-color-light: #FFD700; /* äº®é‡‘è‰² */
            --bg-color: #111111; /* æ·±é»‘èƒŒæ™¯ */
            --text-color: #fff;
            --panel-bg: rgba(0, 0, 0, 0.85);
            --panel-border: rgba(212, 175, 55, 0.5); /* é‡‘è‰²è¾¹æ¡† */
            --button-bg: rgba(212, 175, 55, 0.2); /* åŠé€æ˜é‡‘è‰²æŒ‰é’®èƒŒæ™¯ */
            --button-hover: rgba(212, 175, 55, 0.4);
            --button-active: rgba(212, 175, 55, 0.6);
            --tooltip-bg: rgba(0, 0, 0, 0.85);
            --error-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --gold-shadow: 0 0 8px rgba(212, 175, 55, 0.5); /* é‡‘è‰²é˜´å½± */
        }
        
        @media (prefers-color-scheme: light) {
            :root {
                /* å³ä½¿åœ¨æµ…è‰²æ¨¡å¼ä¸‹ä¹Ÿä¿æŒé»‘é‡‘é…è‰² */
                --bg-color: #111111;
                --text-color: #fff;
                --panel-bg: rgba(0, 0, 0, 0.85);
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow: hidden;
        }
        
        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .panel {
            background: var(--panel-bg);
            border-radius: 10px;
            border: 1px solid var(--panel-border);
            box-shadow: var(--gold-shadow);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }
        
        #overlay {
            position: fixed;
            top: 120px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            z-index: 10;
            max-width: min(250px, 80vw);
        }
        
        #timeline {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            padding: 10px;
            gap: 15px;
            z-index: 10;
            max-width: min(90vw, 600px);
            width: auto;
            flex-wrap: wrap;
            justify-content: center;
        }

        #controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            z-index: 10;
            max-width: min(250px, 80vw);
        }
        
        /* ä¿¡æ¯é¢æ¿ä¸åˆ‡æ¢æŒ‰é’® */
        #info-toggle {
            position: fixed;
            top: 20px;
            right: 280px;
            z-index: 15;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            padding: 0;
            background: var(--button-bg);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            cursor: pointer;
            box-shadow: var(--gold-shadow);
        }
        
        #info-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--panel-border);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9;
            padding: 0 20px;
            transform: translateY(-100%);
            transition: all 0.3s ease;
            box-shadow: var(--gold-shadow);
        }
        
        #info-header.visible {
            transform: translateY(0);
        }
        
        #info-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            overflow-x: auto;
            padding: 0 10px;
            scrollbar-width: thin;
        }
        
        #info-header-content::-webkit-scrollbar {
            height: 3px;
        }
        
        #info-header-content::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        
        #info-header-content .info-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            white-space: nowrap;
        }
        
        #info-header-content .info-label {
            color: var(--primary-color-light);
            margin-right: 5px;
        }
        
        #info-header-content .info-value {
            color: var(--text-color);
            font-weight: bold;
        }
        
        /* ä¾§è¾¹ä¿¡æ¯é¢æ¿ */
        #info-panel {
            position: fixed;
            top: 70px;
            right: -300px;
            width: 280px;
            padding: 15px;
            z-index: 10;
            font-size: 14px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            scrollbar-width: thin;
            transition: all 0.3s ease;
        }
        
        #info-panel.visible {
            right: 20px;
        }
        
        #info-panel::-webkit-scrollbar {
            width: 4px;
        }
        
        #info-panel::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 4px;
        }
        
        #info-panel div {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        #info-panel .label {
            color: var(--primary-color-light);
            margin-right: 10px;
            min-width: 80px;
        }
        
        #info-panel .value {
            color: var(--text-color);
            font-weight: bold;
            text-align: right;
            word-break: break-word;
            max-width: 150px;
        }
        
        #frame-info {
            margin-left: 10px;
            min-width: 100px;
            text-align: center;
        }
        
        .btn {
            padding: 8px 12px;
            color: var(--text-color);
            background: var(--button-bg);
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-shadow: var(--gold-shadow);
        }
        
        .btn:hover {
            background: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
        }
        
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(212, 175, 55, 0.3);
            background: var(--button-active);
        }
        
        .btn-icon {
            display: inline-flex;
            margin-right: 5px;
        }

        select.btn {
            min-width: 150px;
            padding-right: 25px;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px;
        }
        
        #upload {
            width: 100%;
            max-width: 200px;
            position: relative;
            cursor: pointer;
        }

        #upload::file-selector-button {
            display: none;
        }
        
        #progress-container {
            position: relative;
            width: min(300px, 50vw);
            height: 8px;
        }
        
        #progress {
            width: 100%;
            height: 100%;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }
        
        #progress::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--gold-shadow);
        }
        
        #progress-buffer {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0;
            background: rgba(212, 175, 55, 0.3);
            border-radius: 4px;
            pointer-events: none;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: var(--text-color);
            backdrop-filter: blur(5px);
        }
        
        .loading-title {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .loading-progress {
            width: min(300px, 80vw);
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            margin-top: 20px;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            max-width: min(400px, 90vw);
            text-align: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s forwards;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }
        
        .error-message {
            background: rgba(231, 76, 60, 0.2);
            color: var(--error-color);
            border-left: 4px solid var(--error-color);
        }
        
        .success-message {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }
        
        .warning-message {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        .drop-zone {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(212, 175, 55, 0.2);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            pointer-events: none;
            backdrop-filter: blur(5px);
            text-align: center;
        }

        .drop-zone.active {
            display: flex;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--tooltip-bg);
            color: var(--text-color);
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            pointer-events: none;
            border: 1px solid var(--primary-color);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* æ’­æ”¾æ§åˆ¶æ ·å¼ */
        #playPause {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            padding: 0;
        }
        
        /* è§†å›¾æ§åˆ¶é¢æ¿ */
        #view-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            padding: 10px;
            z-index: 10;
            flex-wrap: wrap;
            justify-content: center;
            max-width: min(200px, 80vw);
        }
        
        /* æ€§èƒ½ç›‘æ§é¢æ¿ */
        #stats-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px;
            z-index: 10;
            font-size: 12px;
            color: var(--primary-color);
        }
        
        /* æ¨¡å¼åˆ‡æ¢ */
        #display-mode {
            display: flex;
            gap: 5px;
            padding: 5px;
            z-index: 10;
            border-radius: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        #display-mode .mode-btn {
            padding: 5px 15px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--primary-color-dark);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #display-mode .mode-btn.active {
            background: var(--primary-color);
            color: #000;
        }
        
        /* å¿«æ·é”®é¢æ¿ */
        #shortcuts-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            padding: 15px;
            z-index: 10;
            font-size: 12px;
            display: none;
            max-width: min(350px, 90vw);
            max-height: min(400px, 70vh);
            overflow-y: auto;
        }
        
        #shortcuts-panel.visible {
            display: block;
        }
        
        #shortcuts-panel table {
            width: 100%;
            border-collapse: collapse;
        }
        
        #shortcuts-panel table td {
            padding: 4px 8px;
        }
        
        #shortcuts-panel table tr:hover {
            background: rgba(212, 175, 55, 0.1);
        }
        
        #shortcuts-panel .key {
            color: var(--primary-color);
            background: rgba(212, 175, 55, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 5px;
            white-space: nowrap;
            border: 1px solid var(--primary-color-dark);
        }
        
        /* åŠ¨ç”»é€Ÿåº¦æ§åˆ¶ */
        #speed-control {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }
        
        #playback-speed {
            width: 70px;
            text-align: center;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--primary-color-dark);
            color: var(--text-color);
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 16px;
        }
        
        /* ç›¸æœºè§†è§’æ§åˆ¶ */
        .camera-preset {
            padding: 5px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* åº•éƒ¨ç½‘æ ¼åæ ‡è½´ */
        .axis-label {
            position: absolute;
            color: var(--text-color);
            font-size: 14px;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        /* åŠ¨ç”»å¾ªç¯æ§åˆ¶ */
        #loop-control {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }
        
        #loop-toggle {
            display: inline-block;
            width: 40px;
            height: 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--primary-color-dark);
        }
        
        #loop-toggle.active {
            background: var(--primary-color);
        }
        
        #loop-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 14px;
            border-radius: 50%;
            background: #fff;
            transition: all 0.3s;
        }
        
        #loop-toggle.active::after {
            transform: translateX(20px);
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            #timeline {
                flex-direction: column;
                align-items: center;
                padding: 10px 5px;
                gap: 10px;
                bottom: 10px;
            }
            
            #progress-container {
                width: 90vw;
            }
            
            #controls {
                max-width: 60px;
                padding: 10px 5px;
            }
            
            #controls .btn span:not(.btn-icon) {
                display: none;
            }
            
            #controls .tooltip .tooltip-text {
                width: 120px;
                font-size: 10px;
            }
            
            #info-toggle {
                right: 85px;
            }
            
            #info-panel {
                font-size: 12px;
                min-width: auto;
                right: -250px;
                width: 240px;
            }
            
            #info-panel.visible {
                right: 10px;
            }
            
            #info-header-content {
                font-size: 12px;
            }
            
            #info-header-content .info-item {
                margin-right: 10px;
            }
            
            #view-controls {
                bottom: 10px;
                right: 10px;
                gap: 5px;
                padding: 5px;
            }
            
            .camera-preset {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            #shortcuts-panel {
                bottom: 60px;
                right: 10px;
                padding: 10px;
                font-size: 10px;
            }
            
            #overlay {
                top: 80px;
                left: 10px;
                padding: 10px;
            }
            
            #upload {
                max-width: 150px;
            }
            
            #stats-panel {
                bottom: 10px;
                left: 10px;
                padding: 5px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="scene-container"></div>
    
    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <div id="info-header" class="panel">
        <div id="info-header-content">
            <div class="info-item"><span class="info-label">æ–‡ä»¶å:</span> <span class="info-value" id="header-filename">--</span></div>
            <div class="info-item"><span class="info-label">åŠ¨ç”»æ•°é‡:</span> <span class="info-value" id="header-animations">--</span></div>
            <div class="info-item"><span class="info-label">éª¨éª¼æ•°é‡:</span> <span class="info-value" id="header-bones">--</span></div>
            <div class="info-item"><span class="info-label">åŠ¨ç”»æ—¶é•¿:</span> <span class="info-value" id="header-duration">--</span></div>
            <div class="info-item"><span class="info-label">å¸§ç‡:</span> <span class="info-value" id="header-fps">--</span></div>
            <div class="info-item"><span class="info-label">é¡¶ç‚¹æ•°:</span> <span class="info-value" id="header-vertices">--</span></div>
            <div class="info-item"><span class="info-label">é¢æ•°:</span> <span class="info-value" id="header-faces">--</span></div>
            <div class="info-item"><span class="info-label">æè´¨æ•°:</span> <span class="info-value" id="header-materials">--</span></div>
        </div>
    </div>
    
    <!-- ä¿¡æ¯é¢æ¿åˆ‡æ¢æŒ‰é’® -->
    <button id="info-toggle" class="btn tooltip">
        <span class="btn-icon">â„¹ï¸</span>
        <span class="tooltip-text">æ˜¾ç¤º/éšè—ä¿¡æ¯é¢æ¿</span>
    </button>
    
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div id="overlay" class="panel">
        <input type="file" id="upload" class="btn" accept=".fbx,.gltf,.glb,.obj,.dae,.zip">
        <select id="animSelect" class="btn">
            <option value="-1">æ— åŠ¨ç”»</option>
        </select>
    </div>
    
    <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
    <div id="controls" class="panel">
        <button id="toggle-skeleton" class="btn tooltip">
            <span class="btn-icon">âšª</span> <span>éª¨æ¶</span>
            <span class="tooltip-text">æ˜¾ç¤º/éšè—éª¨æ¶</span>
        </button>
        <button id="toggle-bg" class="btn tooltip">
            <span class="btn-icon">ğŸ¨</span> <span>èƒŒæ™¯</span>
            <span class="tooltip-text">åˆ‡æ¢èƒŒæ™¯é¢œè‰²</span>
        </button>
        <button id="reset-camera" class="btn tooltip">
            <span class="btn-icon">ğŸ”„</span> <span>é‡ç½®</span>
            <span class="tooltip-text">é‡ç½®ç›¸æœºè§†è§’</span>
        </button>
        <button id="toggle-grid" class="btn tooltip">
            <span class="btn-icon">ğŸ“</span> <span>ç½‘æ ¼</span>
            <span class="tooltip-text">æ˜¾ç¤º/éšè—ç½‘æ ¼</span>
        </button>
        <button id="toggle-axes" class="btn tooltip">
            <span class="btn-icon">ğŸ§­</span> <span>åæ ‡</span>
            <span class="tooltip-text">æ˜¾ç¤º/éšè—åæ ‡è½´</span>
        </button>
        <button id="screenshot" class="btn tooltip">
            <span class="btn-icon">ğŸ“·</span> <span>æˆªå›¾</span>
            <span class="tooltip-text">ä¿å­˜å½“å‰è§†å›¾</span>
        </button>
        <button id="toggle-floor" class="btn tooltip">
            <span class="btn-icon">ğŸ </span> <span>åœ°é¢</span>
            <span class="tooltip-text">æ˜¾ç¤º/éšè—åå…‰åœ°é¢</span>
        </button>
        <button id="toggle-light" class="btn tooltip">
            <span class="btn-icon">ğŸ’¡</span> <span>å…‰æº</span>
            <span class="tooltip-text">åˆ‡æ¢å…‰ç…§æ¨¡å¼</span>
        </button>
        <button id="toggle-shortcuts" class="btn tooltip">
            <span class="btn-icon">âŒ¨ï¸</span> <span>å¿«æ·é”®</span>
            <span class="tooltip-text">æ˜¾ç¤º/éšè—å¿«æ·é”®åˆ—è¡¨</span>
        </button>
    </div>
    
    <!-- ä¿¡æ¯é¢æ¿ -->
    <div id="info-panel" class="panel">
        <div><span class="label">æ–‡ä»¶å:</span> <span class="value" id="info-filename">--</span></div>
        <div><span class="label">åŠ¨ç”»æ•°é‡:</span> <span class="value" id="info-animations">--</span></div>
        <div><span class="label">éª¨éª¼æ•°é‡:</span> <span class="value" id="info-bones">--</span></div>
        <div><span class="label">åŠ¨ç”»æ—¶é•¿:</span> <span class="value" id="info-duration">--</span></div>
        <div><span class="label">å¸§ç‡:</span> <span class="value" id="info-fps">--</span></div>
        <div><span class="label">é¡¶ç‚¹æ•°:</span> <span class="value" id="info-vertices">--</span></div>
        <div><span class="label">é¢æ•°:</span> <span class="value" id="info-faces">--</span></div>
        <div><span class="label">æè´¨æ•°:</span> <span class="value" id="info-materials">--</span></div>
    </div>
    
    <!-- æ—¶é—´è½´æ§åˆ¶ -->
    <div id="timeline" class="panel">
        <button id="playPause" class="btn">â–¶</button>
        <div id="progress-container">
            <input type="range" id="progress" min="0" max="1" step="0.001" value="0">
            <div id="progress-buffer"></div>
        </div>
        <div id="frame-info">0 / 0 å¸§</div>
        <div id="loop-control">
            <span>å¾ªç¯:</span>
            <div id="loop-toggle" class="active"></div>
        </div>
        <div id="speed-control">
            <span>é€Ÿåº¦:</span>
            <select id="playback-speed">
                <option value="0.25">0.25x</option>
                <option value="0.5">0.5x</option>
                <option value="1" selected="">1x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
            </select>
        </div>
    </div>
    
    <!-- ç›¸æœºè§†è§’é¢„è®¾ -->
    <div id="view-controls" class="panel">
        <button class="btn camera-preset tooltip" data-view="front">
            F
            <span class="tooltip-text">æ­£è§†å›¾</span>
        </button>
        <button class="btn camera-preset tooltip" data-view="back">
            B
            <span class="tooltip-text">åè§†å›¾</span>
        </button>
        <button class="btn camera-preset tooltip" data-view="left">
            L
            <span class="tooltip-text">å·¦è§†å›¾</span>
        </button>
        <button class="btn camera-preset tooltip" data-view="right">
            R
            <span class="tooltip-text">å³è§†å›¾</span>
        </button>
        <button class="btn camera-preset tooltip" data-view="top">
            T
            <span class="tooltip-text">ä¿¯è§†å›¾</span>
        </button>
        <button class="btn camera-preset tooltip" data-view="bottom">
            â†“
            <span class="tooltip-text">ä»°è§†å›¾</span>
        </button>
    </div>
    
    <!-- æ€§èƒ½ç›‘æ§é¢æ¿ -->
    <div id="stats-panel" class="panel">
        <div>FPS: <span id="fps-counter">0</span></div>
        <div>å¸§æ—¶é—´: <span id="frame-time">0</span> ms</div>
        <div>å†…å­˜: <span id="memory-usage">0</span> MB</div>
    </div>
    
    <!-- å¿«æ·é”®è¯´æ˜é¢æ¿ -->
    <div id="shortcuts-panel" class="panel">
        <h3 style="margin-bottom: 10px; color: var(--primary-color);">å¿«æ·é”®åˆ—è¡¨</h3>
        <table>
            <tbody><tr><td><span class="key">ç©ºæ ¼</span></td><td>æ’­æ”¾/æš‚åœ</td></tr>
            <tr><td><span class="key">S</span></td><td>æ˜¾ç¤º/éšè—éª¨æ¶</td></tr>
            <tr><td><span class="key">G</span></td><td>æ˜¾ç¤º/éšè—ç½‘æ ¼</td></tr>
            <tr><td><span class="key">A</span></td><td>æ˜¾ç¤º/éšè—åæ ‡è½´</td></tr>
            <tr><td><span class="key">B</span></td><td>åˆ‡æ¢èƒŒæ™¯é¢œè‰²</td></tr>
            <tr><td><span class="key">R</span></td><td>é‡ç½®ç›¸æœºä½ç½®</td></tr>
            <tr><td><span class="key">P</span></td><td>ä¿å­˜æˆªå›¾</td></tr>
            <tr><td><span class="key">F</span></td><td>æ˜¾ç¤º/éšè—åœ°é¢</td></tr>
            <tr><td><span class="key">L</span></td><td>åˆ‡æ¢å…‰ç…§æ¨¡å¼</td></tr>
            <tr><td><span class="key">C</span></td><td>åˆ‡æ¢åŠ¨ç”»å¾ªç¯</td></tr>
            <tr><td><span class="key">I</span></td><td>æ˜¾ç¤º/éšè—ä¿¡æ¯é¢æ¿</td></tr>
            <tr><td><span class="key">1-5</span></td><td>è®¾ç½®æ’­æ”¾é€Ÿåº¦</td></tr>
            <tr><td><span class="key">W</span></td><td>çº¿æ¡†æ˜¾ç¤ºæ¨¡å¼</td></tr>
            <tr><td><span class="key">X</span></td><td>Xå°„çº¿æ¨¡å¼</td></tr>
            <tr><td><span class="key">M</span></td><td>æè´¨æ˜¾ç¤ºæ¨¡å¼</td></tr>
            <tr><td><span class="key">N</span></td><td>æ­£å¸¸æ˜¾ç¤ºæ¨¡å¼</td></tr>
            <tr><td><span class="key">æ–¹å‘é”®</span></td><td>ç›¸æœºè§†è§’åˆ‡æ¢</td></tr>
        </tbody></table>
    </div>
    
    <!-- åŠ è½½ç•Œé¢ -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-title">æ­£åœ¨åŠ è½½æ¨¡å‹...</div>
        <div id="loading-message" style="margin-top: 10px; color: #ccc; text-align: center; max-width: 80vw;"></div>
        <div class="loading-progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
    </div>

    <!-- æ‹–æ”¾åŒºåŸŸ -->
    <div class="drop-zone" id="drop-zone">
        <div>
            <div style="font-size: 36px; margin-bottom: 10px; color: var(--primary-color);">ğŸ“¥</div>
            <div>æ‹–æ”¾3Dæ–‡ä»¶åˆ°æ­¤å¤„</div>
            <div style="font-size: 14px; margin-top: 10px; opacity: 0.7; color: var(--primary-color-light);">æ”¯æŒ FBX, GLTF, GLB, OBJ, DAE æˆ– ZIP æ–‡ä»¶</div>
        </div>
    </div>
    
    <!-- é”™è¯¯æ¶ˆæ¯å®¹å™¨ -->
    <div id="message-container" style="display: none;"></div>
    
    <!-- JSZip åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { ColladaLoader } from 'three/addons/loaders/ColladaLoader.js';
        
        // ç¡®ä¿ JSZip å…¨å±€å¯ç”¨
        const { JSZip } = window;
        
        // ä¸»è¦å˜é‡
        let scene, camera, renderer, controls, mixer, clock = new THREE.Clock();
        let skeletonHelper, model;
        let isPlaying = true;
        let currentAction;
        let loopAnimations = true;
        let defaultCamPos = new THREE.Vector3(0, 150, 300);
        let fps = 30; // é»˜è®¤å¸§ç‡
        let playbackSpeed = 1.0; // æ’­æ”¾é€Ÿåº¦
        let resourceTracker = new ResourceTracker(); // èµ„æºè·Ÿè¸ªå™¨
        let loadingTimeout; // åŠ è½½è¶…æ—¶å®šæ—¶å™¨
        let infoDisplayMode = 'none'; // ä¿¡æ¯æ˜¾ç¤ºæ¨¡å¼: 'none', 'sidebar', 'header'
        
        // è®¾ç½®é€‰é¡¹
        const options = {
            showSkeleton: false,
            showGrid: true,
            showAxes: false,
            showFloor: false,
            showStats: true,
            displayMode: 'normal',
            lightMode: 'studio'
        };
        
        // èƒŒæ™¯è‰²åˆ—è¡¨ - è°ƒæ•´ä¸ºé»‘é‡‘é…è‰²
        const bgColors = [
            0x111111,  // æ·±é»‘
            0x000000,  // çº¯é»‘
            0x1a1000,  // æ·±æ£•é»‘
            0x2c2c2c,  // æ·±ç°
            0x191970,  // åˆå¤œè“
            0x4a3c2c,  // é’é“œè‰²
            0x4d4d4d,  // æ·±ç°è‰²
            0x2f4f4f   // æš—é’è‰²
        ];
        let bgIndex = 0;
        
        // DOMå…ƒç´ 
        const container = document.getElementById('scene-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const progressBar = document.getElementById('progress-bar');
        const dropZone = document.getElementById('drop-zone');
        const animSelect = document.getElementById('animSelect');
        const shortcutsPanel = document.getElementById('shortcuts-panel');
        const loopToggle = document.getElementById('loop-toggle');
        const infoPanel = document.getElementById('info-panel');
        const infoHeader = document.getElementById('info-header');
        const infoToggle = document.getElementById('info-toggle');
        
        // æ€§èƒ½ç›‘æ§
        const stats = {
            fps: 0,
            frameTime: 0,
            frames: 0,
            lastTime: 0,
            updateTime: 0,
            memoryUsage: 0
        };
        
        // åœºæ™¯å¯¹è±¡
        let grid, axes, floor;
        let lights = {
            ambient: null,
            directional: null,
            point: null,
            hemisphere: null
        };
        
        // æè´¨å±•ç¤º
        let matcapTexture = null;
        let originalMaterials = new WeakMap(); // å­˜å‚¨åŸå§‹æè´¨çš„å¼±å¼•ç”¨æ˜ å°„
        
        /**
         * èµ„æºè·Ÿè¸ªå™¨ - ç”¨äºå†…å­˜ç®¡ç†
         */
        function ResourceTracker() {
            const resources = new Set();
            
            this.track = function(resource) {
                if (resource.dispose || resource instanceof THREE.Object3D) {
                    resources.add(resource);
                }
                return resource;
            };
            
            this.untrack = function(resource) {
                resources.delete(resource);
            };
            
            this.dispose = function() {
                for (const resource of resources) {
                    if (resource instanceof THREE.Object3D) {
                        if (resource.parent) {
                            resource.parent.remove(resource);
                        }
                    }
                    if (resource.dispose) {
                        resource.dispose();
                    }
                }
                resources.clear();
            };
            
            this.getCount = function() {
                return resources.size;
            };
        }
        
        /**
         * åˆå§‹åŒ–åœºæ™¯
         */
        function initScene() {
            try {
                // æ£€æµ‹å¹¶åº”ç”¨é¢œè‰²æ–¹æ¡ˆ - å¼ºåˆ¶ä¸ºé»‘é‡‘è‰²è°ƒ
                document.documentElement.classList.add('dark');
                
                // åˆ›å»ºåœºæ™¯
                scene = resourceTracker.track(new THREE.Scene());
                scene.background = new THREE.Color(bgColors[bgIndex]);
                
                // åˆ›å»ºç›¸æœº
                camera = resourceTracker.track(new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000));
                camera.position.copy(defaultCamPos);
                
                // åˆ›å»ºæ¸²æŸ“å™¨
                renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    powerPreference: 'high-performance',
                    logarithmicDepthBuffer: true
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1;
                renderer.outputEncoding = THREE.sRGBEncoding;
                container.appendChild(renderer.domElement);
                
                // åˆ›å»ºæ§åˆ¶å™¨
                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.screenSpacePanning = true;
                controls.minDistance = 1;
                controls.maxDistance = 1000;
                
                // æ·»åŠ ç½‘æ ¼
                grid = resourceTracker.track(new THREE.GridHelper(200, 20, 0xD4AF37, 0x333333));
                grid.visible = options.showGrid; // ç¡®ä¿ç½‘æ ¼åˆå§‹çŠ¶æ€ä¸é€‰é¡¹åŒ¹é…
                scene.add(grid);
                
                // æ·»åŠ åæ ‡è½´
                axes = resourceTracker.track(new THREE.AxesHelper(100));
                axes.visible = options.showAxes;
                scene.add(axes);
                
                // æ·»åŠ å…‰æº
                setupLights();
                
                // åˆ›å»ºåœ°é¢
                createFloor();
                
                // å»¶è¿ŸåŠ è½½æè´¨ - é¿å…é˜»å¡åˆå§‹åŒ–
                setTimeout(() => {
                    new THREE.TextureLoader().load(
                        'https://threejs.org/examples/textures/matcaps/matcap-porcelain-white.jpg', 
                        function(texture) {
                            matcapTexture = resourceTracker.track(texture);
                        },
                        undefined,
                        function(error) {
                            console.warn('æ— æ³•åŠ è½½æè´¨è´´å›¾:', error);
                        }
                    );
                    
                    // åŠ è½½HDRç¯å¢ƒè´´å›¾
                    new RGBELoader()
                        .setPath('https://threejs.org/examples/textures/equirectangular/')
                        .load(
                            'royal_esplanade_1k.hdr', 
                            function(hdrMap) {
                                hdrMap.mapping = THREE.EquirectangularReflectionMapping;
                                scene.environment = resourceTracker.track(hdrMap);
                            },
                            undefined,
                            function(error) {
                                console.warn('æ— æ³•åŠ è½½ç¯å¢ƒè´´å›¾:', error);
                            }
                        );
                }, 100);
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                setupEventListeners();
                setupDragAndDrop();
                
                // åˆå§‹åŒ–æ€§èƒ½ç›‘æ§
                initStats();
                
                // å¼€å§‹æ¸²æŸ“å¾ªç¯
                requestAnimationFrame(animate);
                
                // ç§»åŠ¨æ˜¾ç¤ºæ¨¡å¼é¢æ¿åˆ°æ§åˆ¶é¢æ¿
                moveDisplayModeToControls();
                
                // éšè—åŠ è½½ç•Œé¢
                document.getElementById('timeline').style.display = 'none';
                
                // è®¾ç½®ä¿¡æ¯é¢æ¿åˆ‡æ¢æŒ‰é’®å’Œäº‹ä»¶
                setupInfoPanel();
                
                console.log('åœºæ™¯åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                showMessage(error.message || 'åˆå§‹åŒ–åœºæ™¯å¤±è´¥', 'error');
                console.error('åˆå§‹åŒ–åœºæ™¯å¤±è´¥', error);
            }
        }
        
        /**
         * è®¾ç½®ä¿¡æ¯é¢æ¿
         */
        function setupInfoPanel() {
            infoToggle.addEventListener('click', toggleInfoPanel);
            
            // æ·»åŠ é”®ç›˜å¿«æ·é”® - 'i' æ˜¾ç¤º/éšè—ä¿¡æ¯é¢æ¿
            document.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === 'i' && !e.ctrlKey && !e.altKey && !e.metaKey) {
                    toggleInfoPanel();
                }
            });
        }
        
        /**
         * åˆ‡æ¢ä¿¡æ¯é¢æ¿æ˜¾ç¤ºçŠ¶æ€
         */
        function toggleInfoPanel() {
            // å¾ªç¯åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼: none -> header -> sidebar -> none
            switch(infoDisplayMode) {
                case 'none':
                    infoDisplayMode = 'header';
                    infoHeader.classList.add('visible');
                    infoPanel.classList.remove('visible');
                    break;
                case 'header':
                    infoDisplayMode = 'sidebar';
                    infoHeader.classList.remove('visible');
                    infoPanel.classList.add('visible');
                    break;
                case 'sidebar':
                    infoDisplayMode = 'none';
                    infoHeader.classList.remove('visible');
                    infoPanel.classList.remove('visible');
                    break;
            }
            
            showMessage(`ä¿¡æ¯é¢æ¿: ${getInfoDisplayModeName(infoDisplayMode)}`, 'success');
        }
        
        /**
         * è·å–ä¿¡æ¯æ˜¾ç¤ºæ¨¡å¼åç§°
         */
        function getInfoDisplayModeName(mode) {
            switch(mode) {
                case 'none': return 'éšè—';
                case 'header': return 'é¡¶éƒ¨æ ';
                case 'sidebar': return 'ä¾§è¾¹æ ';
                default: return 'æœªçŸ¥';
            }
        }
        
        /**
         * è®¾ç½®å…‰æº
         */
        function setupLights() {
            // ç¯å¢ƒå…‰
            lights.ambient = resourceTracker.track(new THREE.AmbientLight(0xffffff, 0.5));
            scene.add(lights.ambient);
            
            // å¹³è¡Œå…‰
            lights.directional = resourceTracker.track(new THREE.DirectionalLight(0xffffff, 0.8));
            lights.directional.position.set(50, 200, 100);
            lights.directional.castShadow = true;
            lights.directional.shadow.mapSize.width = 1024;
            lights.directional.shadow.mapSize.height = 1024;
            lights.directional.shadow.camera.near = 0.5;
            lights.directional.shadow.camera.far = 500;
            lights.directional.shadow.camera.left = -100;
            lights.directional.shadow.camera.right = 100;
            lights.directional.shadow.camera.top = 100;
            lights.directional.shadow.camera.bottom = -100;
            scene.add(lights.directional);
            
            // åŠçƒå…‰
            lights.hemisphere = resourceTracker.track(new THREE.HemisphereLight(0xffffff, 0x444444, 0.3));
            scene.add(lights.hemisphere);
            
            // ç‚¹å…‰æº
            lights.point = resourceTracker.track(new THREE.PointLight(0xffffff, 0.5));
            lights.point.position.set(0, 150, 50);
            lights.point.castShadow = true;
            lights.point.visible = false;
            scene.add(lights.point);
        }
        
        /**
         * åˆ›å»ºåå…‰åœ°é¢
         */
        function createFloor() {
            const floorGeometry = resourceTracker.track(new THREE.PlaneGeometry(400, 400));
            const floorMaterial = resourceTracker.track(new THREE.MeshStandardMaterial({
                color: 0x222222,
                metalness: 0.5,
                roughness: 0.2,
                envMapIntensity: 1.0
            }));
            
            floor = resourceTracker.track(new THREE.Mesh(floorGeometry, floorMaterial));
            floor.receiveShadow = true;
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = 0;
            floor.visible = options.showFloor;
            scene.add(floor);
        }
        
        /**
         * åˆå§‹åŒ–æ€§èƒ½ç›‘æ§
         */
        function initStats() {
            const fpsCounter = document.getElementById('fps-counter');
            const frameTime = document.getElementById('frame-time');
            const memoryUsage = document.getElementById('memory-usage');
            
            // æ›´æ–°æ€§èƒ½æ•°æ®
            function updateStats() {
                if (stats.updateTime > 1000) {
                    fpsCounter.textContent = stats.fps.toFixed(1);
                    frameTime.textContent = stats.frameTime.toFixed(2);
                    
                    // ä¼°ç®—å†…å­˜ä½¿ç”¨é‡
                    if (window.performance && window.performance.memory) {
                        stats.memoryUsage = Math.round(window.performance.memory.usedJSHeapSize / 1048576);
                    } else {
                        stats.memoryUsage = resourceTracker.getCount();
                    }
                    memoryUsage.textContent = stats.memoryUsage;
                    
                    stats.fps = 0;
                    stats.frames = 0;
                    stats.updateTime = 0;
                }
            }
            
            // å®šæ—¶æ›´æ–°UI
            setInterval(updateStats, 500);
        }
        
        /**
         * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
         */
        function setupEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('upload').addEventListener('change', e => {
                const file = e.target.files[0];
                if (file) {
                    loadFile(file);
                }
            });
            
            // æ‹–æ”¾äº‹ä»¶
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('active');
                
                const file = e.dataTransfer.files[0];
                if (file) {
                    const extension = file.name.split('.').pop().toLowerCase();
                    if (['fbx', 'gltf', 'glb', 'obj', 'dae', 'zip'].includes(extension)) {
                        loadFile(file);
                    } else {
                        showMessage('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼', 'error');
                    }
                }
            });
            
            // éª¨æ¶æ˜¾ç¤º
            document.getElementById('toggle-skeleton').addEventListener('click', toggleSkeleton);
            
            // èƒŒæ™¯åˆ‡æ¢
            document.getElementById('toggle-bg').addEventListener('click', toggleBackground);
            
            // ç›¸æœºé‡ç½®
            document.getElementById('reset-camera').addEventListener('click', resetCamera);
            
            // ç½‘æ ¼æ˜¾ç¤º
            document.getElementById('toggle-grid').addEventListener('click', toggleGrid);
            
            // åæ ‡è½´æ˜¾ç¤º
            document.getElementById('toggle-axes').addEventListener('click', toggleAxes);
            
            // æˆªå›¾åŠŸèƒ½
            document.getElementById('screenshot').addEventListener('click', takeScreenshot);
            
            // åœ°é¢æ˜¾ç¤º
            document.getElementById('toggle-floor').addEventListener('click', toggleFloor);
            
            // å…‰ç…§æ¨¡å¼
            document.getElementById('toggle-light').addEventListener('click', toggleLightMode);
            
            // å¿«æ·é”®é¢æ¿
            document.getElementById('toggle-shortcuts').addEventListener('click', toggleShortcuts);
            
            // æ’­æ”¾æ§åˆ¶
            document.getElementById('playPause').addEventListener('click', togglePlayback);
            document.getElementById('progress').addEventListener('input', updateProgress);
            document.getElementById('playback-speed').addEventListener('change', updatePlaybackSpeed);
            
            // å¾ªç¯æ§åˆ¶
            loopToggle.addEventListener('click', toggleLoop);
            
            // åŠ¨ç”»é€‰æ‹©
            animSelect.addEventListener('change', changeAnimation);
            
            // ç›¸æœºè§†è§’é¢„è®¾
            const viewBtns = document.querySelectorAll('#view-controls .camera-preset');
            viewBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    setCameraView(this.dataset.view);
                });
            });
            
            // é”®ç›˜äº‹ä»¶
            window.addEventListener('keydown', handleKeyPress);
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', onWindowResize);
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ– - èŠ‚çœèµ„æº
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    clock.stop();
                } else {
                    clock.start();
                }
            });
        }
        
        /**
         * åˆ‡æ¢åŠ¨ç”»å¾ªç¯
         */
        function toggleLoop() {
            loopAnimations = !loopAnimations;
            loopToggle.classList.toggle('active', loopAnimations);
            
            if (currentAction) {
                currentAction.loop = loopAnimations ? THREE.LoopRepeat : THREE.LoopOnce;
                currentAction.clampWhenFinished = !loopAnimations;
                
                // å¦‚æœå½“å‰åŠ¨ç”»å·²ç»ç»“æŸä¸”åˆ‡æ¢ä¸ºå¾ªç¯æ¨¡å¼ï¼Œåˆ™é‡ç½®åŠ¨ç”»
                if (loopAnimations && currentAction.paused) {
                    currentAction.paused = false;
                    currentAction.reset();
                    currentAction.play();
                }
            }
            
            showMessage(loopAnimations ? 'åŠ¨ç”»å¾ªç¯æ’­æ”¾' : 'åŠ¨ç”»å•æ¬¡æ’­æ”¾', 'success');
        }
        
        /**
         * å¤„ç†é”®ç›˜äº‹ä»¶
         */
        function handleKeyPress(e) {
            // å¦‚æœåœ¨è¾“å…¥æ¡†ä¸­ï¼Œä¸å“åº”å¿«æ·é”®
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch (e.key.toLowerCase()) {
                case ' ': // ç©ºæ ¼
                    togglePlayback();
                    break;
                case 's': // sé”®
                    toggleSkeleton();
                    break;
                case 'g': // gé”®
                    toggleGrid();
                    break;
                case 'a': // aé”®
                    toggleAxes();
                    break;
                case 'b': // bé”®
                    toggleBackground();
                    break;
                case 'r': // ré”®
                    resetCamera();
                    break;
                case 'p': // pé”®
                    takeScreenshot();
                    break;
                case 'f': // fé”®
                    toggleFloor();
                    break;
                case 'l': // lé”®
                    toggleLightMode();
                    break;
                case 'c': // cé”®
                    toggleLoop();
                    break;
                case 'i': // ié”®
                    toggleInfoPanel();
                    break;
                case 'w': // wé”®
                    setDisplayMode('wireframe');
                    updateModeButtons('wireframe');
                    break;
                case 'x': // xé”®
                    setDisplayMode('xray');
                    updateModeButtons('xray');
                    break;
                case 'm': // mé”®
                    setDisplayMode('matcap');
                    updateModeButtons('matcap');
                    break;
                case 'n': // né”®
                    setDisplayMode('normal');
                    updateModeButtons('normal');
                    break;
                case '1': // 1é”® - 0.25xé€Ÿåº¦
                    setPlaybackSpeed(0.25);
                    break;
                case '2': // 2é”® - 0.5xé€Ÿåº¦
                    setPlaybackSpeed(0.5);
                    break;
                case '3': // 3é”® - 1.0xé€Ÿåº¦
                    setPlaybackSpeed(1.0);
                    break;
                case '4': // 4é”® - 1.5xé€Ÿåº¦
                    setPlaybackSpeed(1.5);
                    break;
                case '5': // 5é”® - 2.0xé€Ÿåº¦
                    setPlaybackSpeed(2.0);
                    break;
                case 'arrowup': // ä¸Šæ–¹å‘é”® - é¡¶è§†å›¾
                    setCameraView('top');
                    break;
                case 'arrowdown': // ä¸‹æ–¹å‘é”® - åº•è§†å›¾
                    setCameraView('bottom');
                    break;
                case 'arrowleft': // å·¦æ–¹å‘é”® - å·¦è§†å›¾
                    setCameraView('left');
                    break;
                case 'arrowright': // å³æ–¹å‘é”® - å³è§†å›¾
                    setCameraView('right');
                    break;
            }
        }
        
        /**
         * æ›´æ–°æ¨¡å¼æŒ‰é’®æ˜¾ç¤º
         */
        function updateModeButtons(mode) {
            const modeBtns = document.querySelectorAll('#display-mode .mode-btn');
            modeBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
        }
        
        /**
         * è®¾ç½®æ’­æ”¾é€Ÿåº¦
         */
        function setPlaybackSpeed(speed) {
            playbackSpeed = parseFloat(speed);
            document.getElementById('playback-speed').value = speed.toString();
            
            if (mixer && currentAction) {
                currentAction.setEffectiveTimeScale(playbackSpeed);
            }
            
            showMessage(`æ’­æ”¾é€Ÿåº¦è®¾ä¸º ${playbackSpeed}x`, 'success');
        }
        
        /**
         * è®¾ç½®ç›¸æœºè§†è§’
         */
        function setCameraView(view) {
            if (!model) return;
            
            // è·å–æ¨¡å‹è¾¹ç•Œ
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const distance = maxDim * 2;
            
            // è®¾ç½®ç›¸æœºä½ç½®
            switch (view) {
                case 'front':
                    camera.position.set(0, center.y, distance);
                    break;
                case 'back':
                    camera.position.set(0, center.y, -distance);
                    break;
                case 'left':
                    camera.position.set(-distance, center.y, 0);
                    break;
                case 'right':
                    camera.position.set(distance, center.y, 0);
                    break;
                case 'top':
                    camera.position.set(0, distance + center.y, 0);
                    break;
                case 'bottom':
                    camera.position.set(0, -distance + center.y, 0);
                    break;
            }
            
            // è®¾ç½®æ§åˆ¶å™¨ç›®æ ‡
            controls.target.copy(center);
            controls.update();
            
            showMessage(`å·²åˆ‡æ¢åˆ°${getViewName(view)}`, 'success');
        }
        
        /**
         * è·å–è§†å›¾åç§°
         */
        function getViewName(view) {
            const names = {
                'front': 'æ­£è§†å›¾',
                'back': 'åè§†å›¾',
                'left': 'å·¦è§†å›¾',
                'right': 'å³è§†å›¾',
                'top': 'ä¿¯è§†å›¾',
                'bottom': 'ä»°è§†å›¾'
            };
            return names[view] || 'æœªçŸ¥è§†å›¾';
        }
        
        /**
         * è®¾ç½®æ˜¾ç¤ºæ¨¡å¼
         */
        function setDisplayMode(mode) {
            options.displayMode = mode;
            
            if (!model) return;
            
            // æ¢å¤æ‰€æœ‰æè´¨
            restoreOriginalMaterials();
            
            // æ ¹æ®æ¨¡å¼è®¾ç½®æè´¨
            model.traverse((object) => {
                if (object.isMesh) {
                    switch (mode) {
                        case 'normal':
                            // æ­£å¸¸æ¨¡å¼å·²ç»åœ¨ä¸Šé¢æ¢å¤äº†
                            break;
                        case 'wireframe':
                            applyWireframeMaterial(object);
                            break;
                        case 'xray':
                            applyXrayMaterial(object);
                            break;
                        case 'matcap':
                            applyMatcapMaterial(object);
                            break;
                    }
                }
            });
            
            showMessage(`å·²åˆ‡æ¢åˆ°${getModeName(mode)}æ¨¡å¼`, 'success');
        }
        
        /**
         * æ¢å¤æ‰€æœ‰åŸå§‹æè´¨
         */
        function restoreOriginalMaterials() {
            if (!model) return;
            
            model.traverse((object) => {
                if (object.isMesh && originalMaterials.has(object)) {
                    object.material = originalMaterials.get(object);
                }
            });
        }
        
        /**
         * åº”ç”¨çº¿æ¡†æè´¨
         */
        function applyWireframeMaterial(object) {
            // ä¿å­˜åŸå§‹æè´¨
            if (!originalMaterials.has(object)) {
                originalMaterials.set(object, object.material);
            }
            
            // åº”ç”¨çº¿æ¡†æè´¨
            if (Array.isArray(object.material)) {
                object.material = object.material.map(() => {
                    return resourceTracker.track(new THREE.MeshBasicMaterial({
                        wireframe: true,
                        color: 0xD4AF37
                    }));
                });
            } else {
                object.material = resourceTracker.track(new THREE.MeshBasicMaterial({
                    wireframe: true,
                    color: 0xD4AF37
                }));
            }
        }
        
        /**
         * åº”ç”¨Xå°„çº¿æè´¨
         */
        function applyXrayMaterial(object) {
            // ä¿å­˜åŸå§‹æè´¨
            if (!originalMaterials.has(object)) {
                originalMaterials.set(object, object.material);
            }
            
            // åˆ›å»ºXå°„çº¿æè´¨ - ä½¿ç”¨é‡‘è‰²è°ƒ
            const xrayMat = resourceTracker.track(new THREE.MeshBasicMaterial({
                color: 0xD4AF37,
                opacity: 0.3,
                transparent: true,
                side: THREE.DoubleSide,
                depthWrite: false
            }));
            
            // åº”ç”¨æè´¨
            if (Array.isArray(object.material)) {
                // ä¸ºæ¯ä¸ªå­æè´¨åˆ›å»ºä¸€ä¸ªæ–°çš„Xå°„çº¿æè´¨
                object.material = Array(object.material.length).fill().map(() => xrayMat.clone());
            } else {
                object.material = xrayMat;
            }
        }
        
        /**
         * åº”ç”¨MatCapæè´¨
         */
        function applyMatcapMaterial(object) {
            // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½æè´¨è´´å›¾
            if (!matcapTexture) {
                // å¦‚æœè´´å›¾æœªåŠ è½½ï¼Œå°è¯•åŠ è½½ä¸€ä¸ªé»˜è®¤æè´¨è´´å›¾
                const loader = new THREE.TextureLoader();
                loader.load('https://threejs.org/examples/textures/matcaps/matcap-gold.jpg', 
                    function(texture) {
                        matcapTexture = resourceTracker.track(texture);
                        // è´´å›¾åŠ è½½å®Œæˆåé‡æ–°è°ƒç”¨æ­¤å‡½æ•°
                        applyMatcapMaterial(object);
                    },
                    undefined,
                    function(error) {
                        console.warn('æ— æ³•åŠ è½½æè´¨è´´å›¾:', error);
                        // å°è¯•åŠ è½½å¤‡ç”¨æè´¨
                        loader.load('https://threejs.org/examples/textures/matcaps/matcap-porcelain-white.jpg', 
                            function(texture) {
                                matcapTexture = resourceTracker.track(texture);
                                applyMatcapMaterial(object);
                            }
                        );
                    }
                );
                return;
            }
            
            // ä¿å­˜åŸå§‹æè´¨
            if (!originalMaterials.has(object)) {
                originalMaterials.set(object, object.material);
            }
            
            // åˆ›å»ºMatCapæè´¨
            const matcapMat = resourceTracker.track(new THREE.MeshMatcapMaterial({
                matcap: matcapTexture,
                flatShading: false
            }));
            
            // åº”ç”¨æè´¨
            if (Array.isArray(object.material)) {
                // ä¸ºæ¯ä¸ªå­æè´¨åˆ›å»ºä¸€ä¸ªæ–°çš„MatCapæè´¨
                object.material = Array(object.material.length).fill().map(() => matcapMat.clone());
            } else {
                object.material = matcapMat;
            }
        }
        
        /**
         * è·å–æ¨¡å¼åç§°
         */
        function getModeName(mode) {
            const names = {
                'normal': 'æ­£å¸¸',
                'wireframe': 'çº¿æ¡†',
                'xray': 'é€è§†',
                'matcap': 'æè´¨'
            };
            return names[mode] || 'æœªçŸ¥';
        }
        
        /**
         * æ›´æ–°æ’­æ”¾é€Ÿåº¦
         */
        function updatePlaybackSpeed(e) {
            setPlaybackSpeed(parseFloat(e.target.value));
        }
        
        /**
         * è®¾ç½®æ‹–æ”¾åŠŸèƒ½
         */
        function setupDragAndDrop() {
            // å¤„ç†æ‹–æ‹½è¿›å…¥æ–‡æ¡£äº‹ä»¶
            document.body.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('active');
            });
            
            // å¤„ç†æ‹–æ‹½ç¦»å¼€äº‹ä»¶
            document.body.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // æ£€æŸ¥æ˜¯å¦çœŸçš„ç¦»å¼€äº†æ–‡æ¡£åŒºåŸŸ
                const rect = document.body.getBoundingClientRect();
                const x = e.clientX;
                const y = e.clientY;
                
                if (x <= rect.left || x >= rect.right || y <= rect.top || y >= rect.bottom) {
                    dropZone.classList.remove('active');
                }
            });
            
            // å¤„ç†æ”¾ç½®äº‹ä»¶
            document.body.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('active');
                
                const file = e.dataTransfer.files[0];
                if (file) {
                    const extension = file.name.split('.').pop().toLowerCase();
                    if (['fbx', 'gltf', 'glb', 'obj', 'dae', 'zip'].includes(extension)) {
                        loadFile(file);
                    } else {
                        showMessage('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ' + extension, 'error');
                    }
                }
            });
        }
        
        /**
         * çª—å£å¤§å°è°ƒæ•´å¤„ç†
         */
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        /**
         * æ˜¾ç¤ºæ¶ˆæ¯
         */
        function showMessage(message, type = 'success') {
            const messageContainer = document.getElementById('message-container');
            
            // åˆ›å»ºæ–°æ¶ˆæ¯å…ƒç´ 
            const newMessage = document.createElement('div');
            newMessage.className = `message ${type}-message`;
            newMessage.textContent = message;
            
            // æ¸…é™¤ç°æœ‰æ¶ˆæ¯
            messageContainer.innerHTML = '';
            messageContainer.appendChild(newMessage);
            messageContainer.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (messageContainer.contains(newMessage)) {
                    messageContainer.removeChild(newMessage);
                    if (messageContainer.children.length === 0) {
                        messageContainer.style.display = 'none';
                    }
                }
            }, 3000);
        }
        
        /**
         * æ›´æ–°åŠ è½½çŠ¶æ€ä¿¡æ¯
         */
        function updateLoadingMessage(message) {
            if (loadingMessage) {
                loadingMessage.textContent = message;
            }
        }
        
        /**
         * åŠ è½½æ–‡ä»¶
         */
        function loadFile(file) {
            try {
                // æ˜¾ç¤ºåŠ è½½ç•Œé¢
                showLoading(true, `æ­£åœ¨åŠ è½½: ${file.name}`);
                progressBar.style.width = '0%';
                
                // æ¸…ç†è¶…æ—¶å®šæ—¶å™¨
                if (loadingTimeout) {
                    clearTimeout(loadingTimeout);
                }
                
                // è®¾ç½®åŠ è½½è¶…æ—¶ - 30ç§’
                loadingTimeout = setTimeout(() => {
                    showMessage('åŠ è½½è¶…æ—¶ï¼Œè¯·å°è¯•å…¶ä»–æ–‡ä»¶æˆ–åˆ·æ–°é¡µé¢', 'error');
                    showLoading(false);
                }, 30000);
                
                // æ¸…é™¤ä¹‹å‰çš„èµ„æº
                cleanupModel();
                
                const extension = file.name.split('.').pop().toLowerCase();
                
                if (extension === 'zip') {
                    handleZipFile(file);
                } else {
                    loadModel(file);
                }
            } catch (error) {
                clearTimeout(loadingTimeout);
                showMessage('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
                showLoading(false);
                console.error('åŠ è½½æ–‡ä»¶å¤±è´¥', error);
            }
        }
        
        /**
         * æ¸…ç†æ¨¡å‹èµ„æº
         */
        function cleanupModel() {
            // åœæ­¢åŠ¨ç”»
            if (mixer) {
                mixer.stopAllAction();
                mixer = null;
            }
            
            // ç§»é™¤éª¨æ¶æ˜¾ç¤º
            if (skeletonHelper) {
                scene.remove(skeletonHelper);
                skeletonHelper = null;
            }
            
            // ç§»é™¤æ¨¡å‹
            if (model) {
                scene.remove(model);
                model = null;
            }
            
            // æ¸…ç†æè´¨æ˜ å°„
            originalMaterials = new WeakMap();
            
            // æ¸…ç†THREE.jsèµ„æº
            resourceTracker.dispose();
            resourceTracker = new ResourceTracker();
            
            // é‡æ–°æ·»åŠ å’Œé…ç½®ç½‘æ ¼å’Œåæ ‡è½´ç­‰
            grid = resourceTracker.track(new THREE.GridHelper(200, 20, 0xD4AF37, 0x333333));
            grid.visible = options.showGrid; // ç¡®ä¿ä¸å½“å‰é€‰é¡¹ä¸€è‡´
            scene.add(grid);
            
            axes = resourceTracker.track(new THREE.AxesHelper(100));
            axes.visible = options.showAxes;
            scene.add(axes);
            
            // å¼ºåˆ¶åƒåœ¾å›æ”¶
            if (window.gc) {
                window.gc();
            }
        }
        
        /**
         * æ˜¾ç¤º/éšè—åŠ è½½ç•Œé¢
         */
        function showLoading(show, message = 'æ­£åœ¨åŠ è½½æ¨¡å‹...') {
            loadingOverlay.style.display = show ? 'flex' : 'none';
            if (show) {
                updateLoadingMessage(message);
                progressBar.style.width = '0%';
            }
        }
        
        /**
         * åŠ è½½FBXæ¨¡å‹
         */
        function loadFBXModel(file) {
            updateLoadingMessage('è§£æFBXæ–‡ä»¶...');
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const loader = new FBXLoader();
                    const arrayBuffer = event.target.result;
                    
                    updateLoadingMessage('æ­£åœ¨å¤„ç†æ¨¡å‹æ•°æ®...');
                    
                    // è·å–ä¸å¸¦æ‰©å±•åçš„æ–‡ä»¶å
                    const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, '');
                    
                    const fbx = loader.parse(arrayBuffer, file.name);
                    
                    // ä¿å­˜æ–‡ä»¶ååˆ°fbxå¯¹è±¡
                    fbx.name = fileNameWithoutExt;
                    
                    // è·Ÿè¸ªå’Œæ·»åŠ æ¨¡å‹
                    model = resourceTracker.track(fbx);
                    scene.add(model);
                    
                    // æ›´æ–°æ¨¡å‹ä¿¡æ¯ï¼Œå¢åŠ ç»Ÿè®¡
                    updateModelInfo(fbx);
                    
                    // è°ƒæ•´æ¨¡å‹ä½ç½®å’Œå¤§å°
                    centerAndScaleModel();
                    
                    // åº”ç”¨å½“å‰æ˜¾ç¤ºæ¨¡å¼
                    setDisplayMode(options.displayMode);
                    
                    // æ·»åŠ éª¨æ¶æ˜¾ç¤º
                    setupSkeletonHelper();
                    
                    // è®¾ç½®åŠ¨ç”»
                    setupAnimations(fbx);
                    
                    // å®ŒæˆåŠ è½½
                    clearTimeout(loadingTimeout);
                    showLoading(false);
                    showMessage(`æ¨¡å‹ "${fbx.name}" å·²åŠ è½½`, 'success');
                } catch (error) {
                    clearTimeout(loadingTimeout);
                    showMessage('è§£æFBXæ¨¡å‹å¤±è´¥: ' + error.message, 'error');
                    showLoading(false);
                    console.error('è§£æFBXæ¨¡å‹å¤±è´¥', error);
                }
            };
            
            reader.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentComplete = (event.loaded / event.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                    updateLoadingMessage(`è¯»å–æ–‡ä»¶: ${Math.round(percentComplete)}%`);
                }
            };
            
            reader.onerror = function(error) {
                clearTimeout(loadingTimeout);
                showMessage('æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message, 'error');
                showLoading(false);
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        /**
         * å±…ä¸­å’Œç¼©æ”¾æ¨¡å‹
         */
        function centerAndScaleModel() {
            if (!model) return;
            
            // è®¡ç®—åŒ…å›´ç›’
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            // æ‰¾å‡ºæœ€å¤§å°ºå¯¸
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 100 / maxDim;
            
            // åº”ç”¨ç¼©æ”¾
            model.scale.multiplyScalar(scale);
            
            // å±…ä¸­æ¨¡å‹
            model.position.x = -center.x * scale;
            model.position.y = -box.min.y * scale;
            model.position.z = -center.z * scale;
            
            // è°ƒæ•´ç›¸æœºä½ç½®ä¸ºæ­£å¥½çœ‹åˆ°æ•´ä¸ªæ¨¡å‹
            const distance = maxDim * 1.5;
            camera.position.set(distance, distance * 0.8, distance);
            controls.target.set(0, size.y * scale * 0.5, 0);
            controls.update();
        }
        
        /**
         * è®¾ç½®éª¨æ¶è¾…åŠ©æ˜¾ç¤º
         */
        function setupSkeletonHelper() {
            let hasSkinnedMesh = false;
            
            model.traverse(function(object) {
                if (object.isSkinnedMesh) {
                    hasSkinnedMesh = true;
                }
            });
            
            if (hasSkinnedMesh) {
                skeletonHelper = resourceTracker.track(new THREE.SkeletonHelper(model));
                skeletonHelper.visible = options.showSkeleton;
                scene.add(skeletonHelper);
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('toggle-skeleton').style.display = 'flex';
            } else {
                document.getElementById('toggle-skeleton').style.display = 'none';
            }
        }
        
        /**
         * è®¾ç½®åŠ¨ç”»ç³»ç»Ÿ
         */
        function setupAnimations(fbx) {
            // åˆ›å»ºåŠ¨ç”»æ··åˆå™¨
            if (fbx.animations && fbx.animations.length > 0) {
                mixer = new THREE.AnimationMixer(model);
                
                // æ›´æ–°åŠ¨ç”»é€‰æ‹©ä¸‹æ‹‰æ¡†
                animSelect.innerHTML = '';
                
                if (fbx.animations.length === 1) {
                    const option = document.createElement('option');
                    option.value = 0;
                    option.textContent = fbx.name || 'Unnamed';
                    animSelect.appendChild(option);
                } else {
                    fbx.animations.forEach((clip, i) => {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = clip.name || `åŠ¨ç”» ${i + 1}`;
                        animSelect.appendChild(option);
                    });
                }
                
                // æ’­æ”¾ç¬¬ä¸€ä¸ªåŠ¨ç”»
                currentAction = mixer.clipAction(fbx.animations[0]);
                currentAction.setEffectiveTimeScale(playbackSpeed);
                currentAction.loop = loopAnimations ? THREE.LoopRepeat : THREE.LoopOnce;
                if (!loopAnimations) {
                    currentAction.clampWhenFinished = true;
                }
                currentAction.play();
                
                // è®¾ç½®æ—¶é—´è½´å¯è§
                document.getElementById('timeline').style.display = 'flex';
            } else {
                animSelect.innerHTML = '<option value="-1">æ— åŠ¨ç”»</option>';
                document.getElementById('timeline').style.display = 'none';
            }
        }
        
        /**
         * æ›´æ–°æ¨¡å‹ä¿¡æ¯
         */
        function updateModelInfo(fbx) {
            // è®¡ç®—æ¨¡å‹ç»Ÿè®¡ä¿¡æ¯
            let verticesCount = 0;
            let facesCount = 0;
            let bonesCount = 0;
            let materialsSet = new Set();
            
            fbx.traverse(function(child) {
                // è®¡ç®—é¡¶ç‚¹å’Œé¢æ•°
                if (child.isMesh && child.geometry) {
                    if (child.geometry.attributes.position) {
                        verticesCount += child.geometry.attributes.position.count;
                    }
                    if (child.geometry.index) {
                        facesCount += child.geometry.index.count / 3;
                    } else if (child.geometry.attributes.position) {
                        facesCount += child.geometry.attributes.position.count / 3;
                    }
                    
                    // è®¡ç®—æè´¨æ•°é‡
                    if (child.material) {
                        if (Array.isArray(child.material)) {
                            child.material.forEach(mat => materialsSet.add(mat));
                        } else {
                            materialsSet.add(child.material);
                        }
                    }
                }
                
                // è®¡ç®—éª¨éª¼æ•°é‡
                if (child.isBone) {
                    bonesCount++;
                }
            });
            
            // è·å–åŠ¨ç”»ä¿¡æ¯
            const clip = fbx.animations && fbx.animations[0];
            const duration = clip ? clip.duration.toFixed(2) : '--';
            
            // æ›´æ–°ä¿¡æ¯é¢æ¿
            document.getElementById('info-filename').textContent = fbx.name;
            document.getElementById('info-animations').textContent = fbx.animations ? fbx.animations.length : 0;
            document.getElementById('info-bones').textContent = bonesCount;
            document.getElementById('info-duration').textContent = `${duration} ç§’`;
            document.getElementById('info-fps').textContent = fps;
            document.getElementById('info-vertices').textContent = Math.round(verticesCount).toLocaleString();
            document.getElementById('info-faces').textContent = Math.round(facesCount).toLocaleString();
            document.getElementById('info-materials').textContent = materialsSet.size;
            
            // æ›´æ–°é¡¶éƒ¨ä¿¡æ¯æ 
            document.getElementById('header-filename').textContent = fbx.name;
            document.getElementById('header-animations').textContent = fbx.animations ? fbx.animations.length : 0;
            document.getElementById('header-bones').textContent = bonesCount;
            document.getElementById('header-duration').textContent = `${duration} ç§’`;
            document.getElementById('header-fps').textContent = fps;
            document.getElementById('header-vertices').textContent = Math.round(verticesCount).toLocaleString();
            document.getElementById('header-faces').textContent = Math.round(facesCount).toLocaleString();
            document.getElementById('header-materials').textContent = materialsSet.size;
            
            // åŠ è½½å®Œæˆåæ ¹æ®è®¾ç½®æ˜¾ç¤ºä¿¡æ¯é¢æ¿
            if (infoDisplayMode === 'header') {
                infoHeader.classList.add('visible');
                infoPanel.classList.remove('visible');
            } else if (infoDisplayMode === 'sidebar') {
                infoHeader.classList.remove('visible');
                infoPanel.classList.add('visible');
            } else {
                infoHeader.classList.remove('visible');
                infoPanel.classList.remove('visible');
            }
        }
        
        /**
         * æ›´æ–°å¸§ä¿¡æ¯æ˜¾ç¤º
         */
        function updateFrameInfo() {
            const frameInfo = document.getElementById('frame-info');
            if (mixer && currentAction) {
                const clip = currentAction.getClip();
                if (clip) {
                    const duration = clip.duration;
                    const totalFrames = Math.round(duration * fps);
                    const currentFrame = Math.round(currentAction.time * fps);
                    frameInfo.textContent = `${currentFrame} / ${totalFrames} å¸§`;
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    const progress = document.getElementById('progress');
                    const progressBuffer = document.getElementById('progress-buffer');
                    if (!progress.isScrubbing) {
                        progress.value = currentAction.time / duration;
                        progressBuffer.style.width = (currentAction.time / duration * 100) + '%';
                    }
                }
            }
        }
        
        /**
         * åˆ‡æ¢éª¨æ¶æ˜¾ç¤º
         */
        function toggleSkeleton() {
            if (!skeletonHelper) return;
            
            options.showSkeleton = !options.showSkeleton;
            skeletonHelper.visible = options.showSkeleton;
            
            const btn = document.getElementById('toggle-skeleton');
            btn.innerHTML = `
                <span class="btn-icon">${options.showSkeleton ? 'âš«' : 'âšª'}</span> <span>${options.showSkeleton ? 'éšè—' : 'æ˜¾ç¤º'}éª¨æ¶</span>
                <span class="tooltip-text">æ˜¾ç¤º/éšè—éª¨æ¶</span>
            `;
            
            showMessage(options.showSkeleton ? 'å·²æ˜¾ç¤ºéª¨æ¶' : 'å·²éšè—éª¨æ¶', 'success');
        }
        
        /**
         * åˆ‡æ¢ç½‘æ ¼æ˜¾ç¤º
         */
        function toggleGrid() {
            options.showGrid = !options.showGrid;
            grid.visible = options.showGrid;
            
            const btn = document.getElementById('toggle-grid');
            btn.innerHTML = `
                <span class="btn-icon">ğŸ“</span> <span>${options.showGrid ? 'éšè—' : 'æ˜¾ç¤º'}ç½‘æ ¼</span>
                <span class="tooltip-text">æ˜¾ç¤º/éšè—ç½‘æ ¼</span>
            `;
            
            showMessage(options.showGrid ? 'å·²æ˜¾ç¤ºç½‘æ ¼' : 'å·²éšè—ç½‘æ ¼', 'success');
        }
        
        /**
         * åˆ‡æ¢åæ ‡è½´æ˜¾ç¤º
         */
        function toggleAxes() {
            options.showAxes = !options.showAxes;
            axes.visible = options.showAxes;
            
            const btn = document.getElementById('toggle-axes');
            btn.innerHTML = `
                <span class="btn-icon">ğŸ§­</span> <span>${options.showAxes ? 'éšè—' : 'æ˜¾ç¤º'}åæ ‡</span>
                <span class="tooltip-text">æ˜¾ç¤º/éšè—åæ ‡è½´</span>
            `;
            
            showMessage(options.showAxes ? 'å·²æ˜¾ç¤ºåæ ‡è½´' : 'å·²éšè—åæ ‡è½´', 'success');
        }
        
        /**
         * åˆ‡æ¢åœ°é¢æ˜¾ç¤º
         */
        function toggleFloor() {
            options.showFloor = !options.showFloor;
            floor.visible = options.showFloor;
            
            const btn = document.getElementById('toggle-floor');
            btn.innerHTML = `
                <span class="btn-icon">ğŸ </span> <span>${options.showFloor ? 'éšè—' : 'æ˜¾ç¤º'}åœ°é¢</span>
                <span class="tooltip-text">æ˜¾ç¤º/éšè—åå…‰åœ°é¢</span>
            `;
            
            showMessage(options.showFloor ? 'å·²æ˜¾ç¤ºåå…‰åœ°é¢' : 'å·²éšè—åå…‰åœ°é¢', 'success');
        }
        
        /**
         * åˆ‡æ¢å…‰ç…§æ¨¡å¼
         */
        function toggleLightMode() {
            const modes = ['studio', 'outdoor', 'dramatic', 'soft'];
            const currentIndex = modes.indexOf(options.lightMode);
            const nextIndex = (currentIndex + 1) % modes.length;
            options.lightMode = modes[nextIndex];
            
            // åº”ç”¨å…‰ç…§æ¨¡å¼
            switch (options.lightMode) {
                case 'studio':
                    lights.ambient.intensity = 0.5;
                    lights.directional.intensity = 0.8;
                    lights.directional.position.set(50, 200, 100);
                    lights.hemisphere.intensity = 0.3;
                    lights.point.visible = false;
                    break;
                case 'outdoor':
                    lights.ambient.intensity = 0.8;
                    lights.directional.intensity = 1.2;
                    lights.directional.position.set(50, 200, -100);
                    lights.hemisphere.intensity = 0.6;
                    lights.point.visible = false;
                    break;
                case 'dramatic':
                    lights.ambient.intensity = 0.2;
                    lights.directional.intensity = 1.0;
                    lights.directional.position.set(-100, 100, 50);
                    lights.hemisphere.intensity = 0.1;
                    lights.point.visible = true;
                    lights.point.position.set(50, 50, 50);
                    lights.point.intensity = 1.0;
                    break;
                case 'soft':
                    lights.ambient.intensity = 0.7;
                    lights.directional.intensity = 0.3;
                    lights.directional.position.set(0, 100, 0);
                    lights.hemisphere.intensity = 0.5;
                    lights.point.visible = false;
                    break;
            }
            
            showMessage(`å…‰ç…§æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${getLightModeName(options.lightMode)}`, 'success');
        }
        
        /**
         * è·å–å…‰ç…§æ¨¡å¼åç§°
         */
        function getLightModeName(mode) {
            const names = {
                'studio': 'å·¥ä½œå®¤',
                'outdoor': 'æˆ·å¤–',
                'dramatic': 'æˆå‰§åŒ–',
                'soft': 'æŸ”å’Œ'
            };
            return names[mode] || 'æœªçŸ¥';
        }
        
        /**
         * åˆ‡æ¢èƒŒæ™¯é¢œè‰²
         */
        function toggleBackground() {
            bgIndex = (bgIndex + 1) % bgColors.length;
            scene.background = new THREE.Color(bgColors[bgIndex]);
            showMessage('èƒŒæ™¯é¢œè‰²å·²æ›´æ”¹', 'success');
        }
        
        /**
         * é‡ç½®ç›¸æœºè§†è§’
         */
        function resetCamera() {
            if (model) {
                // å¦‚æœæœ‰æ¨¡å‹ï¼Œé‡ç½®ä¸ºæŸ¥çœ‹æ•´ä¸ªæ¨¡å‹çš„ä½ç½®
                centerAndScaleModel();
            } else {
                // å¦åˆ™æ¢å¤é»˜è®¤ä½ç½®
                camera.position.copy(defaultCamPos);
                controls.target.set(0, 0, 0);
                controls.update();
            }
            
            showMessage('ç›¸æœºä½ç½®å·²é‡ç½®', 'success');
        }
        
        /**
         * åˆ‡æ¢æ’­æ”¾/æš‚åœ
         */
        function togglePlayback() {
            if (!currentAction) return;
            
            // å¦‚æœåŠ¨ç”»æ˜¯å•æ¬¡æ’­æ”¾ä¸”å·²ç»ç»“æŸï¼Œéœ€è¦é‡ç½®
            if (!loopAnimations && 
                currentAction.loop === THREE.LoopOnce && 
                currentAction.time >= currentAction.getClip().duration) {
                // é‡ç½®åŠ¨ç”»
                currentAction.reset();
                isPlaying = true;
            } else {
                isPlaying = !isPlaying;
            }
            
            document.getElementById('playPause').textContent = isPlaying ? 'â¸' : 'â–¶';
            
            // å¦‚æœæš‚åœäº†åŠ¨ç”»ï¼Œç¡®ä¿å®ƒä¸ä¼šè¢«æ ‡è®°ä¸ºæš‚åœçŠ¶æ€ (è¿™ä¼šé˜»æ­¢å†æ¬¡æ’­æ”¾)
            if (currentAction.paused) {
                currentAction.paused = false;
            }
            
            showMessage(isPlaying ? 'æ’­æ”¾ä¸­' : 'å·²æš‚åœ', 'success');
        }
        
        /**
         * æ›´æ–°åŠ¨ç”»è¿›åº¦
         */
        function updateProgress(e) {
            if (mixer && currentAction) {
                const duration = currentAction.getClip().duration;
                currentAction.time = e.target.value * duration;
                mixer.update(0);
                updateFrameInfo();
                
                // è®¾ç½®æ ‡å¿—è¡¨ç¤ºç”¨æˆ·æ­£åœ¨æ‹–åŠ¨
                e.target.isScrubbing = true;
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (e.target.scrubTimer) {
                    clearTimeout(e.target.scrubTimer);
                }
                
                // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¢å¤è‡ªåŠ¨æ›´æ–°
                e.target.scrubTimer = setTimeout(() => {
                    e.target.isScrubbing = false;
                }, 500);
                
                // å¦‚æœåŠ¨ç”»æ˜¯å•æ¬¡æ’­æ”¾ä¸”æ‹–åŠ¨åå·²ç»ç»“æŸï¼Œåœæ­¢æ’­æ”¾
                if (!loopAnimations && 
                    currentAction.loop === THREE.LoopOnce && 
                    currentAction.time >= duration) {
                    isPlaying = false;
                    document.getElementById('playPause').textContent = 'â–¶';
                }
            }
        }
        
        /**
         * åˆ‡æ¢åŠ¨ç”»
         */
        function changeAnimation(e) {
            const index = parseInt(e.target.value);
            if (index === -1 || !mixer || !model) return;
            
            if (currentAction) currentAction.stop();
            currentAction = mixer.clipAction(model.animations[index]);
            currentAction.setEffectiveTimeScale(playbackSpeed);
            currentAction.loop = loopAnimations ? THREE.LoopRepeat : THREE.LoopOnce;
            if (!loopAnimations) {
                currentAction.clampWhenFinished = true;
            }
            currentAction.reset().play();
            isPlaying = true;
            document.getElementById('playPause').textContent = 'â¸';
            
            showMessage(`æ­£åœ¨æ’­æ”¾åŠ¨ç”»: ${currentAction.getClip().name || `åŠ¨ç”» ${index + 1}`}`, 'success');
        }
        
        /**
         * æˆªå›¾åŠŸèƒ½
         */
        function takeScreenshot() {
            try {
                // ä¸´æ—¶éšè—UI
                const panels = document.querySelectorAll('.panel');
                panels.forEach(panel => panel.style.display = 'none');
                infoToggle.style.display = 'none';
                
                // æ¸²æŸ“åœºæ™¯
                renderer.render(scene, camera);
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.href = renderer.domElement.toDataURL('image/png');
                link.download = (model ? model.name : 'fbx-viewer') + '-screenshot.png';
                link.click();
                
                // æ¢å¤UI
                setTimeout(() => {
                    panels.forEach(panel => {
                        if (panel.id === 'timeline' && (!mixer || !currentAction)) {
                            // å¦‚æœæ²¡æœ‰åŠ¨ç”»ï¼Œä¸æ˜¾ç¤ºæ—¶é—´è½´
                            return;
                        }
                        if (panel.id === 'info-panel' && infoDisplayMode !== 'sidebar') {
                            // æ ¹æ®ä¿¡æ¯é¢æ¿æ¨¡å¼æ¢å¤
                            return;
                        }
                        if (panel.id === 'info-header' && infoDisplayMode !== 'header') {
                            // æ ¹æ®ä¿¡æ¯é¢æ¿æ¨¡å¼æ¢å¤
                            return;
                        }
                        panel.style.display = 'flex';
                    });
                    infoToggle.style.display = 'flex';
                }, 100);
                
                showMessage('æˆªå›¾å·²ä¿å­˜', 'success');
            } catch (error) {
                showMessage('æˆªå›¾ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        /**
         * åˆ‡æ¢å¿«æ·é”®é¢æ¿
         */
        function toggleShortcuts() {
            shortcutsPanel.classList.toggle('visible');
        }
        
        /**
         * ä¼˜åŒ–çš„åŠ¨ç”»å¾ªç¯
         */
        function animate(time) {
            requestAnimationFrame(animate);
            
            // è®¡ç®—å¸§ç‡ - é€šè¿‡ç´¯ç§¯è®¡ç®—æé«˜ç²¾åº¦
            const delta = time - stats.lastTime;
            stats.lastTime = time;
            
            if (delta > 0) {
                stats.frameTime = delta;
                stats.frames++;
                stats.updateTime += delta;
                stats.fps = 1000 / delta;
            }
            
            // ä»…åœ¨å¯è§æ—¶æ‰§è¡Œæ¸²æŸ“ - æ€§èƒ½ä¼˜åŒ–
            if (document.visibilityState === 'visible') {
                // æ›´æ–°æ§åˆ¶å™¨ - ä»…åœ¨éœ€è¦æ—¶æ›´æ–°
                if (controls) controls.update();
                
                // æ›´æ–°åŠ¨ç”» - ä½¿ç”¨ä¸€è‡´çš„æ—¶é—´æº
                if (mixer && isPlaying) {
                    const mixerDelta = clock.getDelta();
                    mixer.update(mixerDelta);
                    if (currentAction) {
                        updateFrameInfo();
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å•æ¬¡æ’­æ”¾å¹¶ä¸”å·²å®Œæˆ
                        if (!loopAnimations && 
                            currentAction.loop === THREE.LoopOnce && 
                            currentAction.time >= currentAction.getClip().duration) {
                            if (isPlaying) {
                                isPlaying = false;
                                document.getElementById('playPause').textContent = 'â–¶';
                            }
                        }
                    }
                }
                
                // ä»…å½“å¯è§æ€§æ”¹å˜æ—¶æ›´æ–°éª¨æ¶æ˜¾ç¤ºçŠ¶æ€
                if (skeletonHelper && skeletonHelper.visible !== options.showSkeleton) {
                    skeletonHelper.visible = options.showSkeleton;
                }
                
                // æ£€æŸ¥ç½‘æ ¼çš„å¯è§æ€§
                if (grid && grid.visible !== options.showGrid) {
                    grid.visible = options.showGrid;
                }
                
                // æ£€æŸ¥åæ ‡è½´çš„å¯è§æ€§
                if (axes && axes.visible !== options.showAxes) {
                    axes.visible = options.showAxes;
                }
                
                // æ¸²æŸ“åœºæ™¯
                renderer.render(scene, camera);
            }
        }
        
        /**
         * åŠ è½½æ¨¡å‹
         */
        function loadModel(file) {
            updateLoadingMessage(`åŠ è½½${file.name}...`);
            
            // æ¸…é™¤ä¹‹å‰çš„æ¨¡å‹
            cleanupModel();
            
            const extension = file.name.split('.').pop().toLowerCase();
            
            if (extension === 'zip') {
                handleZipFile(file);
            } else if (extension === 'fbx') {
                loadFBXModel(file);
            } else if (extension === 'gltf' || extension === 'glb') {
                loadGLTFModel(file);
            } else if (extension === 'obj') {
                loadOBJModel(file);
            } else if (extension === 'dae') {
                loadColladaModel(file);
            } else {
                clearTimeout(loadingTimeout);
                showMessage(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${extension}`, 'error');
                showLoading(false);
            }
        }
        
        /**
         * åŠ è½½GLTFæ¨¡å‹
         */
        function loadGLTFModel(file) {
            updateLoadingMessage('åŠ è½½GLTF/GLBæ¨¡å‹...');
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const blob = new Blob([event.target.result], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    
                    const loader = new GLTFLoader();
                    loader.load(
                        url,
                        function(gltf) {
                            // åŠ è½½æˆåŠŸ
                            URL.revokeObjectURL(url);
                            
                            // è·å–æ–‡ä»¶å
                            const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, '');
                            
                            // è®¾ç½®æ¨¡å‹
                            model = resourceTracker.track(gltf.scene);
                            model.name = fileNameWithoutExt;
                            scene.add(model);
                            
                            // è®¾ç½®åŠ¨ç”»
                            if (gltf.animations && gltf.animations.length > 0) {
                                model.animations = gltf.animations;
                                setupAnimations(model);
                            } else {
                                document.getElementById('timeline').style.display = 'none';
                            }
                            
                            // æ›´æ–°æ¨¡å‹ä¿¡æ¯
                            updateModelInfo(model);
                            
                            // å±…ä¸­æ¨¡å‹
                            centerAndScaleModel();
                            
                            // æ·»åŠ éª¨æ¶æ˜¾ç¤º
                            setupSkeletonHelper();
                            
                            // åº”ç”¨æ˜¾ç¤ºæ¨¡å¼
                            setDisplayMode(options.displayMode);
                            
                            // å®ŒæˆåŠ è½½
                            clearTimeout(loadingTimeout);
                            showLoading(false);
                            showMessage(`GLTFæ¨¡å‹ "${fileNameWithoutExt}" å·²åŠ è½½`, 'success');
                        },
                        function(xhr) {
                            // è¿›åº¦å›è°ƒ
                            if (xhr.lengthComputable) {
                                const percentComplete = xhr.loaded / xhr.total * 100;
                                progressBar.style.width = percentComplete + '%';
                                updateLoadingMessage(`åŠ è½½GLTF: ${Math.round(percentComplete)}%`);
                            }
                        },
                        function(error) {
                            // é”™è¯¯å›è°ƒ
                            URL.revokeObjectURL(url);
                            clearTimeout(loadingTimeout);
                            showMessage('åŠ è½½GLTFæ¨¡å‹å¤±è´¥: ' + error.message, 'error');
                            showLoading(false);
                        }
                    );
                } catch (error) {
                    clearTimeout(loadingTimeout);
                    showMessage('è§£æGLTFæ¨¡å‹å¤±è´¥: ' + error.message, 'error');
                    showLoading(false);
                }
            };
            
            reader.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentComplete = event.loaded / event.total * 100;
                    progressBar.style.width = percentComplete + '%';
                    updateLoadingMessage(`è¯»å–æ–‡ä»¶: ${Math.round(percentComplete)}%`);
                }
            };
            
            reader.onerror = function() {
                clearTimeout(loadingTimeout);
                showMessage('è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
                showLoading(false);
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        /**
         * åŠ è½½OBJæ¨¡å‹
         */
        function loadOBJModel(file) {
            updateLoadingMessage('åŠ è½½OBJæ¨¡å‹...');
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const loader = new OBJLoader();
                    const obj = loader.parse(event.target.result);
                    
                    // è·å–æ–‡ä»¶å
                    const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, '');
                    
                    // è®¾ç½®æ¨¡å‹
                    model = resourceTracker.track(obj);
                    model.name = fileNameWithoutExt;
                    scene.add(model);
                    
                    // æ›´æ–°æ¨¡å‹ä¿¡æ¯
                    updateModelInfo(model);
                    
                    // å±…ä¸­æ¨¡å‹
                    centerAndScaleModel();
                    
                    // OBJé€šå¸¸æ²¡æœ‰åŠ¨ç”»
                    document.getElementById('timeline').style.display = 'none';
                    
                    // æ·»åŠ éª¨æ¶æ˜¾ç¤º
                    setupSkeletonHelper();
                    
                    // åº”ç”¨æ˜¾ç¤ºæ¨¡å¼
                    setDisplayMode(options.displayMode);
                    
                    // å®ŒæˆåŠ è½½
                    clearTimeout(loadingTimeout);
                    showLoading(false);
                    showMessage(`OBJæ¨¡å‹ "${fileNameWithoutExt}" å·²åŠ è½½`, 'success');
                } catch (error) {
                    clearTimeout(loadingTimeout);
                    showMessage('è§£æOBJæ¨¡å‹å¤±è´¥: ' + error.message, 'error');
                    showLoading(false);
                }
            };
            
            reader.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentComplete = event.loaded / event.total * 100;
                    progressBar.style.width = percentComplete + '%';
                    updateLoadingMessage(`è¯»å–æ–‡ä»¶: ${Math.round(percentComplete)}%`);
                }
            };
            
            reader.onerror = function() {
                clearTimeout(loadingTimeout);
                showMessage('è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
                showLoading(false);
            };
            
            reader.readAsText(file);
        }
        
        /**
         * åŠ è½½Colladaæ¨¡å‹
         */
        function loadColladaModel(file) {
            updateLoadingMessage('åŠ è½½Collada(DAE)æ¨¡å‹...');
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const loader = new ColladaLoader();
                    const collada = loader.parse(event.target.result, '');
                    
                    // è·å–æ–‡ä»¶å
                    const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, '');
                    
                    // è®¾ç½®æ¨¡å‹
                    model = resourceTracker.track(collada.scene);
                    model.name = fileNameWithoutExt;
                    scene.add(model);
                    
                    // è®¾ç½®åŠ¨ç”»
                    if (collada.animations && collada.animations.length > 0) {
                        model.animations = collada.animations;
                        setupAnimations(model);
                    } else {
                        document.getElementById('timeline').style.display = 'none';
                    }
                    
                    // æ›´æ–°æ¨¡å‹ä¿¡æ¯
                    updateModelInfo(model);
                    
                    // å±…ä¸­æ¨¡å‹
                    centerAndScaleModel();
                    
                    // æ·»åŠ éª¨æ¶æ˜¾ç¤º
                    setupSkeletonHelper();
                    
                    // åº”ç”¨æ˜¾ç¤ºæ¨¡å¼
                    setDisplayMode(options.displayMode);
                    
                    // å®ŒæˆåŠ è½½
                    clearTimeout(loadingTimeout);
                    showLoading(false);
                    showMessage(`Colladaæ¨¡å‹ "${fileNameWithoutExt}" å·²åŠ è½½`, 'success');
                } catch (error) {
                    clearTimeout(loadingTimeout);
                    showMessage('è§£æColladaæ¨¡å‹å¤±è´¥: ' + error.message, 'error');
                    showLoading(false);
                }
            };
            
            reader.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentComplete = event.loaded / event.total * 100;
                    progressBar.style.width = percentComplete + '%';
                    updateLoadingMessage(`è¯»å–æ–‡ä»¶: ${Math.round(percentComplete)}%`);
                }
            };
            
            reader.onerror = function() {
                clearTimeout(loadingTimeout);
                showMessage('è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
                showLoading(false);
            };
            
            reader.readAsText(file);
        }
        
        /**
         * å¤„ç†ZIPæ–‡ä»¶
         */
        async function handleZipFile(file) {
            try {
                updateLoadingMessage('æ­£åœ¨è§£å‹ZIPæ–‡ä»¶...');
                
                // ç¡®ä¿æ­£ç¡®å¼•ç”¨JSZip
                const zip = await new JSZip().loadAsync(file);
                
                // æŸ¥æ‰¾æ¨¡å‹æ–‡ä»¶
                let modelFile = null;
                let animationFiles = [];
                
                // éå†æ‰€æœ‰æ–‡ä»¶
                console.log('ZIPæ–‡ä»¶å†…å®¹:');
                for (const [path, zipEntry] of Object.entries(zip.files)) {
                    console.log(`æ–‡ä»¶: ${path}, æ˜¯å¦ç›®å½•: ${zipEntry.dir}`);
                    
                    if (zipEntry.dir) continue;
                    
                    const normalizedPath = path.replace(/\\/g, '/').toLowerCase();
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ¨¡å‹æ–‡ä»¶
                    if (normalizedPath === 'model.fbx' || 
                        normalizedPath.endsWith('/model.fbx') ||
                        normalizedPath.endsWith('.gltf') || 
                        normalizedPath.endsWith('.glb') || 
                        normalizedPath.endsWith('.obj') || 
                        normalizedPath.endsWith('.dae')) {
                        
                        // ä¼˜å…ˆé€‰æ‹©åä¸ºmodel.fbxçš„æ–‡ä»¶
                        if (normalizedPath === 'model.fbx' || normalizedPath.endsWith('/model.fbx')) {
                            modelFile = zipEntry;
                            updateLoadingMessage(`æ‰¾åˆ°ä¸»æ¨¡å‹æ–‡ä»¶: ${path}`);
                        } else if (!modelFile) {
                            modelFile = zipEntry;
                            updateLoadingMessage(`æ‰¾åˆ°æ¨¡å‹æ–‡ä»¶: ${path}`);
                        }
                    }
                    // æ£€æŸ¥æ˜¯å¦æ˜¯åŠ¨ç”»æ–‡ä»¶ - æ›´çµæ´»çš„æ£€æµ‹
                    else if ((normalizedPath.includes('/animations/') || 
                              normalizedPath.includes('/animation/') ||
                              normalizedPath.match(/anim|motion|action/i)) && 
                             (normalizedPath.endsWith('.fbx') || 
                              normalizedPath.endsWith('.gltf') || 
                              normalizedPath.endsWith('.glb'))) {
                        animationFiles.push(zipEntry);
                        console.log(`æ‰¾åˆ°åŠ¨ç”»æ–‡ä»¶: ${path}`);
                    }
                }
                
                if (!modelFile) {
                    clearTimeout(loadingTimeout);
                    showMessage('ZIPåŒ…ä¸­æ‰¾ä¸åˆ°æ¨¡å‹æ–‡ä»¶', 'error');
                    showLoading(false);
                    return;
                }
                
                // åŠ è½½æ¨¡å‹
                updateLoadingMessage(`æ­£åœ¨è§£ææ¨¡å‹: ${modelFile.name}`);
                const modelData = await modelFile.async('arraybuffer');
                const modelName = modelFile.name;
                const extension = modelName.split('.').pop().toLowerCase();
                
                console.log(`å¼€å§‹åŠ è½½ ${extension} æ ¼å¼æ¨¡å‹...`);
                
                let mainModel;
                try {
                    switch(extension) {
                        case 'fbx':
                            const fbxLoader = new FBXLoader();
                            mainModel = fbxLoader.parse(modelData, modelName);
                            break;
                        case 'gltf':
                        case 'glb':
                            const blob = new Blob([modelData], { type: 'application/octet-stream' });
                            const url = URL.createObjectURL(blob);
                            
                            mainModel = await new Promise((resolve, reject) => {
                                const gltfLoader = new GLTFLoader();
                                gltfLoader.load(url, 
                                    function(gltf) {
                                        // åŠ è½½æˆåŠŸ
                                        URL.revokeObjectURL(url);
                                        
                                        const modelObj = gltf.scene;
                                        if (gltf.animations && gltf.animations.length > 0) {
                                            modelObj.animations = gltf.animations;
                                            console.log(`åŠ è½½äº† ${gltf.animations.length} ä¸ªGLTFåŠ¨ç”»`);
                                        } else {
                                            modelObj.animations = [];
                                        }
                                        
                                        resolve(modelObj);
                                    },
                                    function(xhr) {
                                        // è¿›åº¦å›è°ƒ
                                        if (xhr.lengthComputable) {
                                            const percentComplete = xhr.loaded / xhr.total * 100;
                                            progressBar.style.width = percentComplete + '%';
                                            updateLoadingMessage(`åŠ è½½GLTF: ${Math.round(percentComplete)}%`);
                                        }
                                    },
                                    function(error) {
                                        // é”™è¯¯å›è°ƒ
                                        URL.revokeObjectURL(url);
                                        reject(error);
                                    }
                                );
                            });
                            break;
                        case 'obj':
                            const objLoader = new OBJLoader();
                            const modelText = new TextDecoder().decode(modelData);
                            mainModel = objLoader.parse(modelText);
                            mainModel.animations = [];
                            break;
                        case 'dae':
                            const colladaLoader = new ColladaLoader();
                            const colladaText = new TextDecoder().decode(modelData);
                            mainModel = colladaLoader.parse(colladaText, '').scene;
                            mainModel.animations = [];
                            break;
                    }
                } catch (err) {
                    console.error(`${extension} æ ¼å¼åŠ è½½å¤±è´¥:`, err);
                    clearTimeout(loadingTimeout);
                    showMessage(`åŠ è½½å¤±è´¥: ${err.message}`, 'error');
                    showLoading(false);
                    return;
                }
                
                // å¤„ç†æ¨¡å‹
                model = resourceTracker.track(mainModel);
                model.name = modelFile.name.split('/').pop().replace(/\.[^/.]+$/, '');
                scene.add(model);
                centerAndScaleModel();
                setupSkeletonHelper();
                
                // åŠ è½½åŠ¨ç”»æ–‡ä»¶
                if (animationFiles.length > 0) {
                    updateLoadingMessage(`æ‰¾åˆ° ${animationFiles.length} ä¸ªåŠ¨ç”»æ–‡ä»¶ï¼Œæ­£åœ¨åŠ è½½...`);
                    
                    mixer = new THREE.AnimationMixer(model);
                    animSelect.innerHTML = '';
                    
                    // ç¡®ä¿æ¨¡å‹æœ‰animationså±æ€§
                    if (!model.animations) {
                        model.animations = [];
                    }
                    
                    let loadedAnimations = 0;
                    
                    for (let i = 0; i < animationFiles.length; i++) {
                        const animFile = animationFiles[i];
                        updateLoadingMessage(`åŠ è½½åŠ¨ç”» ${i+1}/${animationFiles.length}: ${animFile.name}`);
                        
                        try {
                            const animData = await animFile.async('arraybuffer');
                            const animName = animFile.name.split('/').pop().replace(/\.(fbx|gltf|glb)$/, '');
                            const animExtension = animFile.name.split('.').pop().toLowerCase();
                            
                            let animClips = [];
                            
                            switch(animExtension) {
                                case 'fbx':
                                    const animLoader = new FBXLoader();
                                    const animModel = animLoader.parse(animData, '');
                                    animClips = animModel.animations || [];
                                    break;
                                case 'gltf':
                                case 'glb':
                                    const blob = new Blob([animData], { type: 'application/octet-stream' });
                                    const url = URL.createObjectURL(blob);
                                    
                                    try {
                                        const gltfAnim = await new Promise((resolve, reject) => {
                                            const gltfLoader = new GLTFLoader();
                                            gltfLoader.load(url, resolve, undefined, reject);
                                        });
                                        
                                        URL.revokeObjectURL(url);
                                        animClips = gltfAnim.animations || [];
                                    } catch (gltfErr) {
                                        URL.revokeObjectURL(url);
                                        console.warn(`æ— æ³•åŠ è½½GLTFåŠ¨ç”»: ${gltfErr.message}`);
                                        continue;
                                    }
                                    break;
                            }
                            
                            if (animClips.length === 0) {
                                console.warn(`åŠ¨ç”»æ–‡ä»¶ ${animName} æœªåŒ…å«åŠ¨ç”»`);
                                continue;
                            }
                            
                            animClips.forEach((clip, index) => {
                                // è®¾ç½®åŠ¨ç”»åç§°
                                clip.name = `${animName}${animClips.length > 1 ? ` (${index + 1})` : ''}`;
                                
                                // å°†åŠ¨ç”»æ·»åŠ åˆ°ä¸»æ¨¡å‹
                                model.animations.push(clip);
                                
                                // æ·»åŠ åˆ°ä¸‹æ‹‰æ¡†
                                const option = document.createElement('option');
                                option.value = model.animations.length - 1;
                                option.textContent = clip.name;
                                animSelect.appendChild(option);
                                
                                loadedAnimations++;
                            });
                        } catch (animError) {
                            console.warn(`åŠ è½½åŠ¨ç”» ${animFile.name} å¤±è´¥:`, animError);
                        }
                    }
                    
                    // å¦‚æœæœ‰åŠ¨ç”»ï¼Œæ’­æ”¾ç¬¬ä¸€ä¸ª
                    if (model.animations && model.animations.length > 0) {
                        setupAnimations(model);
                        showMessage(`æˆåŠŸåŠ è½½ ${loadedAnimations} ä¸ªåŠ¨ç”»`, 'success');
                    } else {
                        document.getElementById('timeline').style.display = 'none';
                        showMessage('æœªæ‰¾åˆ°æœ‰æ•ˆçš„åŠ¨ç”»æ•°æ®', 'warning');
                    }
                } else {
                    console.log('ZIPåŒ…ä¸­æ²¡æœ‰æ‰¾åˆ°åŠ¨ç”»æ–‡ä»¶');
                    
                    // æ£€æŸ¥æ¨¡å‹è‡ªèº«æ˜¯å¦æœ‰åŠ¨ç”»
                    if (model.animations && model.animations.length > 0) {
                        setupAnimations(model);
                    } else {
                        document.getElementById('timeline').style.display = 'none';
                    }
                }
                
                // æ›´æ–°æ¨¡å‹ä¿¡æ¯
                updateModelInfo(model);
                
                // åº”ç”¨æ˜¾ç¤ºæ¨¡å¼
                setDisplayMode(options.displayMode);
                
                // å®ŒæˆåŠ è½½
                clearTimeout(loadingTimeout);
                showLoading(false);
                showMessage(`å·²åŠ è½½æ¨¡å‹: ${model.name}${model.animations ? ` (${model.animations.length} ä¸ªåŠ¨ç”»)` : ''}`, 'success');
                
            } catch (error) {
                clearTimeout(loadingTimeout);
                showMessage('å¤„ç†ZIPæ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
                showLoading(false);
                console.error('å¤„ç†ZIPæ–‡ä»¶å¤±è´¥', error);
            }
        }
        
        /**
         * ç§»åŠ¨æ˜¾ç¤ºæ¨¡å¼é¢æ¿åˆ°æ§åˆ¶é¢æ¿
         */
        function moveDisplayModeToControls() {
            const displayMode = document.createElement('div');
            displayMode.id = 'display-mode';
            displayMode.classList.add('panel');
            displayMode.style.position = 'relative';
            displayMode.style.top = 'auto';
            displayMode.style.left = 'auto';
            displayMode.style.transform = 'none';
            displayMode.style.marginTop = '10px';
            displayMode.style.display = 'flex';
            displayMode.style.gap = '5px';
            
            const modes = [
                { mode: 'normal', text: 'æ­£å¸¸' },
                { mode: 'wireframe', text: 'çº¿æ¡†' },
                { mode: 'xray', text: 'é€è§†' },
                { mode: 'matcap', text: 'æè´¨' }
            ];
            
            modes.forEach((modeInfo, index) => {
                const btn = document.createElement('button');
                btn.classList.add('mode-btn');
                btn.dataset.mode = modeInfo.mode;
                btn.textContent = modeInfo.text;
                
                if (index === 0) {
                    btn.classList.add('active');
                }
                
                btn.addEventListener('click', function() {
                    const modeBtns = displayMode.querySelectorAll('.mode-btn');
                    modeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    setDisplayMode(this.dataset.mode);
                });
                
                displayMode.appendChild(btn);
            });
            
            const controls = document.getElementById('controls');
            const modeContainer = document.createElement('div');
            modeContainer.id = 'mode-container';
            modeContainer.style.marginTop = '15px';
            
            const modeTitle = document.createElement('div');
            modeTitle.style.marginBottom = '5px';
            modeTitle.style.textAlign = 'center';
            modeTitle.style.color = '#D4AF37';
            modeTitle.textContent = 'æ˜¾ç¤ºæ¨¡å¼:';
            
            modeContainer.appendChild(modeTitle);
            modeContainer.appendChild(displayMode);
            
            controls.appendChild(modeContainer);
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        initScene();
    </script>


</body></html>